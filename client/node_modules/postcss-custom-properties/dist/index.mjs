import e from"postcss-value-parser";import t from"fs";import s from"path";import{parse as n}from"postcss";function r(e){var t=e.selector?e:e.parent;return/(!\s*)?postcss-custom-properties:\s*off\b/i.test(t.toString())}function o(t,s){const n={},o={};return t.nodes.slice().forEach((t=>{const a=u(t)?n:p(t)?o:null;a&&(t.nodes.slice().forEach((t=>{if(l(t)&&!r(t)){const{prop:n}=t;a[n]=e(t.value),s.preserve||t.remove()}})),s.preserve||!w(t)||r(t)||t.remove())})),{...n,...o}}const a=/^html$/i,c=/^:root$/i,i=/^--[A-z][\w-]*$/,u=e=>"rule"===e.type&&e.selector.split(",").some((e=>a.test(e)))&&Object(e.nodes).length,p=e=>"rule"===e.type&&e.selector.split(",").some((e=>c.test(e)))&&Object(e.nodes).length,l=e=>"decl"===e.type&&i.test(e.prop),w=e=>0===Object(e.nodes).length;function f(t){const s=Object.assign({},Object(t).customProperties,Object(t)["custom-properties"]);for(const t in s)s[t]=e(String(s[t]));return s}function m(e){return e.map((e=>{if(e instanceof Promise)return e;if(e instanceof Function)return e();const t=e===Object(e)?e:{from:String(e)};if(t.customProperties||t["custom-properties"])return t;const n=s.resolve(String(t.from||""));return{type:(t.type||s.extname(n).slice(1)).toLowerCase(),from:n}})).reduce((async(e,t)=>{const{type:s,from:r}=await t;return"css"===s||"pcss"===s?Object.assign(await e,await async function(e){const t=await v(e);return o(n(t,{from:e}),{preserve:!0})}(r)):"js"===s?Object.assign(await e,await async function(e){return f(await import(e))}(r)):"json"===s?Object.assign(await e,await async function(e){return f(await j(e))}(r)):Object.assign(await e,await f(await t))}),{})}const v=e=>new Promise(((s,n)=>{t.readFile(e,"utf8",((e,t)=>{e?n(e):s(t)}))})),j=async e=>JSON.parse(await v(e));function O(e,t){return e.nodes&&e.nodes.length&&e.nodes.slice().forEach((s=>{if(g(s)){const[n,...r]=s.nodes.filter((e=>"div"!==e.type)),{value:o}=n,a=e.nodes.indexOf(s);if(o in Object(t)){const s=t[o].nodes;!function(e,t,s){const n=Object.assign({},t);delete n[s],O(e,n)}({nodes:s},t,o),a>-1&&e.nodes.splice(a,1,...s)}else r.length&&(a>-1&&e.nodes.splice(a,1,...r),O(e,t))}else O(s,t)})),e.toString()}const d=/^var$/i,g=e=>"function"===e.type&&d.test(e.value)&&Object(e.nodes).length>0;var b=(t,s,n)=>{if(h(t)&&(a=(o=t).prev(),!Boolean(r(o)||a&&"comment"===a.type&&/(!\s*)?postcss-custom-properties:\s*ignore\s+next\b/i.test(a.text)))){const r=t.value;let o=O(e(r),s);const a=new Set;for(;$.test(o)&&!a.has(o);){a.add(o);o=O(e(o),s)}if(o!==r)if(n.preserve){const e=t.cloneBefore({value:o});S(e)&&(e.raws.value.value=e.value.replace(P,"$1"),e.raws.value.raw=e.raws.value.value+e.raws.value.raw.replace(P,"$2"))}else t.value=o,S(t)&&(t.raws.value.value=t.value.replace(P,"$1"),t.raws.value.raw=t.raws.value.value+t.raws.value.raw.replace(P,"$2"))}var o,a};const y=/^--[A-z][\w-]*$/,$=/(^|[^\w-])var\([\W\w]+\)/,h=e=>!y.test(e.prop)&&$.test(e.value),S=e=>"value"in Object(Object(e.raws).value)&&"raw"in e.raws.value&&P.test(e.raws.value.raw),P=/^([\W\w]+)(\s*\/\*[\W\w]+?\*\/)$/;function x(e,t){return Promise.all(t.map((async t=>{if(t instanceof Function)await t(k(e));else{const n=t===Object(t)?t:{to:String(t)},r=n.toJSON||k;if("customProperties"in n)n.customProperties=r(e);else if("custom-properties"in n)n["custom-properties"]=r(e);else{const t=String(n.to||""),o=(n.type||s.extname(n.to).slice(1)).toLowerCase(),a=r(e);"css"===o&&await async function(e,t){const s=`:root {\n${Object.keys(t).reduce(((e,s)=>(e.push(`\t${s}: ${t[s]};`),e)),[]).join("\n")}\n}\n`;await F(e,s)}(t,a),"scss"===o&&await async function(e,t){const s=`${Object.keys(t).reduce(((e,s)=>{const n=s.replace("--","$");return e.push(`${n}: ${t[s]};`),e}),[]).join("\n")}\n`;await F(e,s)}(t,a),"js"===o&&await async function(e,t){const s=`module.exports = {\n\tcustomProperties: {\n${Object.keys(t).reduce(((e,s)=>(e.push(`\t\t'${B(s)}': '${B(t[s])}'`),e)),[]).join(",\n")}\n\t}\n};\n`;await F(e,s)}(t,a),"json"===o&&await async function(e,t){const s=`${JSON.stringify({"custom-properties":t},null,"  ")}\n`;await F(e,s)}(t,a),"mjs"===o&&await async function(e,t){const s=`export const customProperties = {\n${Object.keys(t).reduce(((e,s)=>(e.push(`\t'${B(s)}': '${B(t[s])}'`),e)),[]).join(",\n")}\n};\n`;await F(e,s)}(t,a)}}})))}const k=e=>Object.keys(e).reduce(((t,s)=>{const n=e[s];return t[s]=n.toString(),t}),{}),F=(e,s)=>new Promise(((n,r)=>{t.writeFile(e,s,(e=>{e?r(e):n()}))})),B=e=>e.replace(/\\([\s\S])|(')/g,"\\$1$2").replace(/\n/g,"\\n").replace(/\r/g,"\\r"),E=e=>{const t=!("preserve"in Object(e))||Boolean(e.preserve),s=[].concat(Object(e).importFrom||[]),n=[].concat(Object(e).exportTo||[]),r=m(s);let a;const c=0===s.length&&0===n.length;return{postcssPlugin:"postcss-custom-properties",prepare:({root:e})=>c?(a=o(e,{preserve:t}),{Declaration:e=>b(e,a,{preserve:t})}):{Once:async e=>{a=Object.assign({},o(e,{preserve:t}),await r),await x(a,n)},Declaration:e=>b(e,a,{preserve:t})}}};E.postcss=!0;export{E as default};
