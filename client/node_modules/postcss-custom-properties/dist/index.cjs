"use strict";var e=require("postcss-value-parser"),t=require("fs"),s=require("path"),r=require("postcss");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function o(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(s){if("default"!==s){var r=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(t,s,r.get?r:{enumerable:!0,get:function(){return e[s]}})}})),t.default=e,Object.freeze(t)}var a=n(e),c=n(t),i=n(s);function u(e){var t=e.selector?e:e.parent;return/(!\s*)?postcss-custom-properties:\s*off\b/i.test(t.toString())}function l(e,t){const s={},r={};return e.nodes.slice().forEach((e=>{const n=v(e)?s:d(e)?r:null;n&&(e.nodes.slice().forEach((e=>{if(j(e)&&!u(e)){const{prop:s}=e;n[s]=a.default(e.value),t.preserve||e.remove()}})),t.preserve||!m(e)||u(e)||e.remove())})),{...s,...r}}const p=/^html$/i,f=/^:root$/i,w=/^--[A-z][\w-]*$/,v=e=>"rule"===e.type&&e.selector.split(",").some((e=>p.test(e)))&&Object(e.nodes).length,d=e=>"rule"===e.type&&e.selector.split(",").some((e=>f.test(e)))&&Object(e.nodes).length,j=e=>"decl"===e.type&&w.test(e.prop),m=e=>0===Object(e.nodes).length;function O(e){const t=Object.assign({},Object(e).customProperties,Object(e)["custom-properties"]);for(const e in t)t[e]=a.default(String(t[e]));return t}function b(e){return e.map((e=>{if(e instanceof Promise)return e;if(e instanceof Function)return e();const t=e===Object(e)?e:{from:String(e)};if(t.customProperties||t["custom-properties"])return t;const s=i.default.resolve(String(t.from||""));return{type:(t.type||i.default.extname(s).slice(1)).toLowerCase(),from:s}})).reduce((async(e,t)=>{const{type:s,from:n}=await t;return"css"===s||"pcss"===s?Object.assign(await e,await async function(e){const t=await g(e);return l(r.parse(t,{from:e}),{preserve:!0})}(n)):"js"===s?Object.assign(await e,await async function(e){var t;return O(await(t=e,Promise.resolve().then((function(){return o(require(t))}))))}(n)):"json"===s?Object.assign(await e,await async function(e){return O(await y(e))}(n)):Object.assign(await e,await O(await t))}),{})}const g=e=>new Promise(((t,s)=>{c.default.readFile(e,"utf8",((e,r)=>{e?s(e):t(r)}))})),y=async e=>JSON.parse(await g(e));function $(e,t){return e.nodes&&e.nodes.length&&e.nodes.slice().forEach((s=>{if(P(s)){const[r,...n]=s.nodes.filter((e=>"div"!==e.type)),{value:o}=r,a=e.nodes.indexOf(s);if(o in Object(t)){const s=t[o].nodes;!function(e,t,s){const r=Object.assign({},t);delete r[s],$(e,r)}({nodes:s},t,o),a>-1&&e.nodes.splice(a,1,...s)}else n.length&&(a>-1&&e.nodes.splice(a,1,...n),$(e,t))}else $(s,t)})),e.toString()}const h=/^var$/i,P=e=>"function"===e.type&&h.test(e.value)&&Object(e.nodes).length>0;var S=(e,t,s)=>{if(q(e)&&(n=(r=e).prev(),!Boolean(u(r)||n&&"comment"===n.type&&/(!\s*)?postcss-custom-properties:\s*ignore\s+next\b/i.test(n.text)))){const r=e.value;let n=$(a.default(r),t);const o=new Set;for(;k.test(n)&&!o.has(n);){o.add(n);n=$(a.default(n),t)}if(n!==r)if(s.preserve){const t=e.cloneBefore({value:n});F(t)&&(t.raws.value.value=t.value.replace(E,"$1"),t.raws.value.raw=t.raws.value.value+t.raws.value.raw.replace(E,"$2"))}else e.value=n,F(e)&&(e.raws.value.value=e.value.replace(E,"$1"),e.raws.value.raw=e.raws.value.value+e.raws.value.raw.replace(E,"$2"))}var r,n};const x=/^--[A-z][\w-]*$/,k=/(^|[^\w-])var\([\W\w]+\)/,q=e=>!x.test(e.prop)&&k.test(e.value),F=e=>"value"in Object(Object(e.raws).value)&&"raw"in e.raws.value&&E.test(e.raws.value.raw),E=/^([\W\w]+)(\s*\/\*[\W\w]+?\*\/)$/;function z(e,t){return Promise.all(t.map((async t=>{if(t instanceof Function)await t(B(e));else{const s=t===Object(t)?t:{to:String(t)},r=s.toJSON||B;if("customProperties"in s)s.customProperties=r(e);else if("custom-properties"in s)s["custom-properties"]=r(e);else{const t=String(s.to||""),n=(s.type||i.default.extname(s.to).slice(1)).toLowerCase(),o=r(e);"css"===n&&await async function(e,t){const s=`:root {\n${Object.keys(t).reduce(((e,s)=>(e.push(`\t${s}: ${t[s]};`),e)),[]).join("\n")}\n}\n`;await D(e,s)}(t,o),"scss"===n&&await async function(e,t){const s=`${Object.keys(t).reduce(((e,s)=>{const r=s.replace("--","$");return e.push(`${r}: ${t[s]};`),e}),[]).join("\n")}\n`;await D(e,s)}(t,o),"js"===n&&await async function(e,t){const s=`module.exports = {\n\tcustomProperties: {\n${Object.keys(t).reduce(((e,s)=>(e.push(`\t\t'${J(s)}': '${J(t[s])}'`),e)),[]).join(",\n")}\n\t}\n};\n`;await D(e,s)}(t,o),"json"===n&&await async function(e,t){const s=`${JSON.stringify({"custom-properties":t},null,"  ")}\n`;await D(e,s)}(t,o),"mjs"===n&&await async function(e,t){const s=`export const customProperties = {\n${Object.keys(t).reduce(((e,s)=>(e.push(`\t'${J(s)}': '${J(t[s])}'`),e)),[]).join(",\n")}\n};\n`;await D(e,s)}(t,o)}}})))}const B=e=>Object.keys(e).reduce(((t,s)=>{const r=e[s];return t[s]=r.toString(),t}),{}),D=(e,t)=>new Promise(((s,r)=>{c.default.writeFile(e,t,(e=>{e?r(e):s()}))})),J=e=>e.replace(/\\([\s\S])|(')/g,"\\$1$2").replace(/\n/g,"\\n").replace(/\r/g,"\\r"),N=e=>{const t=!("preserve"in Object(e))||Boolean(e.preserve),s=[].concat(Object(e).importFrom||[]),r=[].concat(Object(e).exportTo||[]),n=b(s);let o;const a=0===s.length&&0===r.length;return{postcssPlugin:"postcss-custom-properties",prepare:({root:e})=>a?(o=l(e,{preserve:t}),{Declaration:e=>S(e,o,{preserve:t})}):{Once:async e=>{o=Object.assign({},l(e,{preserve:t}),await n),await z(o,r)},Declaration:e=>S(e,o,{preserve:t})}}};N.postcss=!0,module.exports=N;
